<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in</title>
   <link rel="stylesheet" href="sprint1.css">
</head>
<body>
      <header>
    <div class="icon">
   
    <img src="logo pals.png" alt="logo" height="80"/>
     <img src="logo gaza.png" alt="Logo" height="80" />
    </div>
    <div>
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7153 0H9.30063C3.47373 0 0 3.472 0 9.296V22.688C0 28.528 3.47373 32 9.30063 32H22.6993C28.5262 32 31.9999 28.528 31.9999 22.704V9.296C32.016 3.472 28.5422 0 22.7153 0ZM21.3867 19.68C21.8509 20.144 21.8509 20.912 21.3867 21.376C21.1465 21.616 20.8424 21.728 20.5382 21.728C20.2341 21.728 19.9299 21.616 19.6898 21.376L16.008 17.696L12.3261 21.376C12.086 21.616 11.7819 21.728 11.4777 21.728C11.1736 21.728 10.8694 21.616 10.6293 21.376C10.1651 20.912 10.1651 20.144 10.6293 19.68L14.3111 16L10.6293 12.32C10.1651 11.856 10.1651 11.088 10.6293 10.624C11.0935 10.16 11.8619 10.16 12.3261 10.624L16.008 14.304L19.6898 10.624C20.154 10.16 20.9224 10.16 21.3867 10.624C21.8509 11.088 21.8509 11.856 21.3867 12.32L17.7048 16L21.3867 19.68Z" fill="#023611"/>
</svg>

    </div>
  </header>
    <div class="signin-container">
       
        <h1 class="signin-title">Sign in</h1>
        <p class="signin-subtitle">Welcome back! Please sign in to continue</p>
        
        <form id="signinForm" style="padding: 5px 80px;">
            <div class="form-group">
                <label class="form-label" for="nationalId">National ID</label>
                <input 
                    type="text" 
                    id="nationalId" 
                    name="nationalId"
                    class="form-input" 
                    placeholder=""
                    required
                    autocomplete="username"
                    maxlength="9"
                    pattern="[0-9]{9}"
                    inputmode="numeric"
                >
                <div class="error-message" id="errorMessage">National ID must be exactly 9 digits</div>
            </div>
            
            <button
  type="button"
  id="continueBtn"
  class="continue-button"
  onclick="goNextPage()"
  disabled
>
  Continue
</button>

        </form>
    </div>

    <script>
    // API Configuration
    const API_CONFIG = {
        baseURL: ' http://localhost:8000/api', // ✨ غيريها حسب سيرفرك
        timeout: 3000,
        endpoints: {
            signin: '/login'
        }
    };

    // API Service
    class AuthAPI {
        constructor(config) {
            this.config = config;
        }

        async makeRequest(endpoint, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), this.config.timeout);

            const url = `${this.config.baseURL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                signal: controller.signal
            };

            try {
                const response = await fetch(url, { ...defaultOptions, ...options });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                return data;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('⏳ Request timeout. Please try again.');
                }
                throw error;
            }
        }

        // ✨ Sign in API call
        async signin(nationalId, password) {
            return this.makeRequest(this.config.endpoints.signin, {
                method: 'POST',
                body: JSON.stringify({
                    type: 'citizen',        // لاحقاً ممكن تعملي اختيار النوع
                    national_id: nationalId,
                    password: password
                })
            });
        }

        validateNationalId(nationalId) {
            const cleaned = nationalId.replace(/\s+/g, '');
            return cleaned.length === 9 && /^[0-9]{9}$/.test(cleaned);
        }
    }

    // Form Handler
    class SignInForm {
        constructor() {
            this.api = new AuthAPI(API_CONFIG);
            this.form = document.getElementById('signinForm');
            this.nationalIdInput = document.getElementById('nationalId');
            this.passwordInput = document.getElementById('password'); // ✨ أضفنا حقل كلمة المرور
            this.continueBtn = document.getElementById('continueBtn');
            this.errorMessage = document.getElementById('errorMessage');
            this.isSubmitting = false;

            this.initializeEventListeners();
        }

        initializeEventListeners() {
            this.form.addEventListener('submit', this.handleSubmit.bind(this));
            this.nationalIdInput.addEventListener('input', this.handleInput.bind(this));
        }

        handleInput(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 9) value = value.substring(0, 9);
            e.target.value = value;

            this.clearError();
            this.continueBtn.disabled = !(value.length === 9);
        }

        async handleSubmit(e) {
            e.preventDefault();
            if (this.isSubmitting) return;

            const nationalId = this.nationalIdInput.value.trim();
            const password = this.passwordInput.value.trim();

            if (!this.api.validateNationalId(nationalId)) {
                return this.showError('National ID must be exactly 9 digits');
            }
            if (!password) {
                return this.showError('Password is required');
            }

            await this.performSignIn(nationalId, password);
        }

        async performSignIn(nationalId, password) {
            this.setLoadingState(true);
            this.clearError();

            try {
                const result = await this.api.signin(nationalId, password);

                // ✨ حفظ التوكن
                localStorage.setItem("token", result.token);

                this.handleSignInSuccess(result);
            } catch (error) {
                console.error('Sign in error:', error);
                this.showError(error.message || 'An error occurred. Please try again.');
            } finally {
                this.setLoadingState(false);
            }
        }

        handleSignInSuccess(result) {
            alert("✅ تم تسجيل الدخول بنجاح!");
            setTimeout(() => {
                window.location.href = 'password.html'; // ✨ الصفحة التالية
            }, 1000);
        }

        setLoadingState(isLoading) {
            this.isSubmitting = isLoading;
            this.continueBtn.disabled = isLoading;
            this.continueBtn.textContent = isLoading ? 'Signing in...' : 'Continue';
        }

        showError(message) {
            this.errorMessage.textContent = message;
            this.errorMessage.style.display = 'block';
            this.nationalIdInput.classList.add('error');
        }

        clearError() {
            this.errorMessage.style.display = 'none';
            this.nationalIdInput.classList.remove('error');
        }
    }

    // Initialize application
    document.addEventListener('DOMContentLoaded', () => {
        new SignInForm();
    });

</script>
  
</body>
</html>